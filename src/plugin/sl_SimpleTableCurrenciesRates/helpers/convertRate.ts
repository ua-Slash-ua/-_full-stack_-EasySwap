/**
 * Конвертує курс валют між форматами:
 * - Для відображення: конвертуємо з бази у формат для відображення (42.5)
 * - Для збереження: конвертуємо з форми (42.5) у формат для збереження (0.0235...)
 *
 * Логіка:
 * - В базі завжди зберігаємо обернений курс (1/X), тобто значення < 1
 * - В UI завжди показуємо прямий курс (X), тобто значення >= 1
 * - При відображенні: якщо значення < 1 - конвертуємо, якщо >= 1 - не конвертуємо (старе значення)
 * - При збереженні: завжди конвертуємо (значення з форми завжди >= 1)
 *
 * @param value - значення курсу
 * @param direction - 'toDisplay' для відображення, 'toStorage' для збереження
 * @returns конвертоване значення
 */
export function convertRate(
  value: number | string | undefined | null,
  direction: 'toDisplay' | 'toStorage',
): number {
  if (!value || value === '' || value === 0) return 0

  const numValue = typeof value === 'string' ? parseFloat(value) : value

  if (isNaN(numValue) || numValue === 0) return 0

  if (direction === 'toDisplay') {
    // Конвертуємо з бази у формат для відображення
    // В базі має зберігатися обернений курс (< 1), тому конвертуємо
    // Якщо значення < 1 - це правильний обернений курс, конвертуємо в прямий
    if (numValue < 1 && numValue > 0) {
      return 1 / numValue
    }
    // Якщо значення >= 1 - це старе значення в неправильному форматі
    // Для сумісності зі старими даними також конвертуємо (1 / 1.185... = 0.843...)
    // Але це може бути неправильно, тому краще мігрувати старі дані
    // Поки що залишаємо як є, щоб не зламати старі значення
    return numValue
  } else {
    // Конвертуємо з форми у формат для збереження
    // З форми завжди приходить прямий курс (X >= 1), тому завжди конвертуємо в обернений
    // Але якщо значення дуже маленьке (наприклад, < 0.1), це може бути вже обернений курс
    // Перевіряємо: якщо значення >= 1 - це прямий курс, конвертуємо
    // Якщо значення < 1 - це вже обернений курс (старе значення), не конвертуємо
    if (numValue >= 1) {
      return 1 / numValue
    }
    // Якщо значення < 1 - це вже обернений курс, повертаємо як є
    return numValue
  }
}
